<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
  <meta charset="UTF-8">
  <title>OKR 리스트</title>
  <style>
    :root { --border:#e5e7eb; --bg:#f9fafb; --muted:#6b7280; --ok:#10b981; --text:#111827; }
    body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; }
    .wrap { max-width: 860px; margin: 40px auto; background: #fff; border:1px solid var(--border); border-radius: 16px; padding: 24px; }
    .obj { border:1px solid var(--border); border-radius:12px; padding:16px; margin-bottom:16px; }
    .kr-item { border:1px solid var(--border); border-radius:12px; padding:12px; margin-bottom:10px; background:#fff; transition: background .2s, box-shadow .2s }
    .kr-item.is-checked { background:#ecfdf5; box-shadow:0 0 0 2px #10b98133 inset }
    .toggle-btn { border:1px solid #d1d5db; border-radius:999px; padding:6px 12px; cursor:pointer; background:#fff; }
    .toggle-btn.is-on { border-color:transparent; background:var(--ok); color:#fff; }
    .kr-meta { color: var(--muted); font-size: 12px; }
    .toast { position:fixed; left:50%; transform:translateX(-50%); bottom:24px; background:#111827; color:#fff; padding:10px 14px; border-radius:10px; opacity:0; pointer-events:none; transition:opacity .2s, transform .2s }
    .toast.show { opacity:1; transform:translateX(-50%) translateY(-6px) }

    /* ✅ 미니 그래프 스타일 */
    .mini-graphs { display:flex; gap:10px; margin-top:8px; }
    .mini-graph { display:flex; align-items:center; gap:6px; font-size:12px; color: var(--muted); }
    .mini-label { font-weight:600; }
    .mini-bar { width:72px; height:8px; background:#e5e7eb; border-radius:999px; overflow:hidden; }
    .mini-fill { height:100%; background:var(--ok); transition: width .35s ease; }
    .mini-percent { min-width:30px; text-align:right; color:#6b7280; }

    /* ✅ Objective: 분기 진행 막대 + 통계 */
.obj-progress {
  margin-top: 10px;
  padding: 12px;
  border: 1px solid var(--border);
  border-radius: 12px;
  background: #fff;
}

.obj-progress-top {
  display: flex;
  align-items: baseline;
  justify-content: space-between;
  gap: 12px;
  flex-wrap: wrap;
}

.obj-progress-title {
  display: flex;
  align-items: center;
  gap: 8px;
}

.obj-progress-title .tag {
  font-size: 11px;
  padding: 3px 8px;
  border-radius: 999px;
  background: #ecfdf5;
  color: #065f46;
  font-weight: 700;
}

.obj-progress-title .percent {
  font-size: 13px;
  font-weight: 800;
  color: var(--text);
}

.obj-progress-meta {
  font-size: 12px;
  color: var(--muted);
  display: flex;
  align-items: center;
  gap: 6px;
}

.obj-progress-meta .dot { opacity: .6; }

.obj-progress-bar {
  margin-top: 10px;
  width: 100%;
  height: 10px;
  background: #e5e7eb;
  border-radius: 999px;
  overflow: hidden;
}

.obj-progress-fill {
  height: 100%;
  background: var(--ok);
  transition: width .35s ease;
}

.obj-stats {
  margin-top: 10px;
  display: flex;
  flex-wrap: wrap;
  gap: 8px 14px;
  align-items: center;
  font-size: 12px;
  color: var(--muted);
}

.obj-stats .stat {
  display: inline-flex;
  gap: 6px;
  align-items: baseline;
}

.obj-stats .label {
  font-weight: 800;
  color: #374151;
}

.obj-stats .value {
  font-weight: 900;
  color: #111827;
}

.obj-stats .stat-strong .value {
  color: var(--ok);
}
  </style>
</head>
<body>
<div class="wrap">
  <h1>OKR 리스트</h1>

  <a href="/"><button>메인으로</button></a>
  <a href="/okr/create" style="margin-left: 10px;"><button>새 OKR 작성하기</button></a>

  <div th:each="objective : ${objectives}"
       class="obj"
       th:attr="data-obj-id=${objective.id}">
    <div style="display:flex; align-items:center; justify-content:space-between;">
      <div>
        <h2 th:text="${objective.title}" style="margin:0;">Objective 제목</h2>

        <span th:text="${objective.dDay}">D-0</span>

        <!-- ✅ 분기 진행 막대 + 체크 통계 -->
        <div class="obj-progress">
          <div class="obj-progress-top">
            <div class="obj-progress-title">
              <span class="tag">OKR</span>
              <span class="percent" th:text="|${objective.quarterProgressPercent}% 진행|">0% 진행</span>
            </div>

            <!-- ✅ meta를 2줄로 -->
            <div class="obj-progress-meta" style="flex-direction:column; align-items:flex-end;">
              <div>
                <span th:text="${objective.dDay}">D-0</span>
                <span class="dot">·</span>
                <span>총 90일</span>
              </div>

              <!-- ✅ OKR 생성 기준 기간(시작~마감) -->
              <div th:if="${objective.startDate != null and objective.endDate != null}"
                   th:text="|${#temporals.format(objective.startDate,'yyyy.MM.dd')} ~ ${#temporals.format(objective.endDate,'yyyy.MM.dd')}|"
                   style="margin-top:4px;">
                2026.01.21 ~ 2026.04.21
              </div>
            </div>
          </div>

          <div class="obj-progress-bar" role="progressbar"
               th:attr="aria-valuenow=${objective.quarterProgressPercent},aria-valuemin=0,aria-valuemax=100">
            <div class="obj-progress-fill"
                 th:style="|width:${objective.quarterProgressPercent}%;|"></div>
          </div>

          <div class="obj-stats">
            <div class="stat">
              <span class="label">오늘</span>
              <span class="value">
    <span class="obj-today-checked" th:text="${objective.todayCheckedCount}">0</span>/<span class="obj-kr-count" th:text="${objective.krCount}">0</span>
    </span>
            </div>
            <div class="stat">
              <span class="label">주</span>
              <span class="value" th:text="|${objective.weekChecks}회|">0회</span>
            </div>
            <div class="stat">
              <span class="label">월</span>
              <span class="value" th:text="|${objective.monthChecks}회|">0회</span>
            </div>
            <div class="stat">
              <span class="label">분기</span>
              <span class="value" th:text="|${objective.quarterChecks}회|">0회</span>
            </div>

            <div class="stat stat-strong">
              <span class="label">달성률(오늘까지)</span>
              <span class="value" th:text="|${objective.achievementPercent}%|">0%</span>
            </div>
          </div>
        </div>


      </div>

      <!-- ✅ Objective 삭제 버튼 -->
      <form th:action="@{/okr/{id}/delete(id=${objective.id})}" method="post"
            onsubmit="return confirm('이 Objective와 모든 KR/체크 기록을 삭제합니다. 계속할까요?');">
        <!-- (시큐리티 사용 시) CSRF -->
        <!-- <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/> -->
        <button type="submit" class="toggle-btn" style="background:#ef4444; color:#fff; border-color:#ef4444;">삭제</button>
      </form>
    </div>

    <p th:text="${objective.description}">Objective 설명</p>

    <!-- ✅ Objective별 KR 추가 폼 -->
    <form th:action="@{|/okr/kr/objective/${objective.id}/create|}" method="post"
          style="margin:12px 0 16px; display:flex; gap:8px; flex-wrap:wrap;">
      <!-- (시큐리티 사용 시) CSRF -->
      <!-- <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/> -->
      <input type="text" name="content" placeholder="새 핵심 결과 내용"
             style="flex:1; padding:8px; border:1px solid var(--border); border-radius:8px;" required>
      <input type="number" name="progress" min="0" max="100" placeholder="진행률(선택)"
             style="width:140px; padding:8px; border:1px solid var(--border); border-radius:8px;">
      <button type="submit" class="toggle-btn">추가</button>
    </form>

    <ul style="list-style:none; padding-left:0; margin:0;">
      <li class="kr-item"
          th:each="kr : ${objective.keyResults}"
          th:classappend="${kr.checkedToday} ? ' is-checked' : ''"
          th:attr="data-kr-id=${kr.id}">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:12px">
          <div>
            <span th:text="${kr.content}" class="kr-title">Key Result 내용</span>

            <div class="kr-meta">
              주간 <span class="kr-week" th:text="${kr.weekCount}">0</span> ·
              월간 <span class="kr-month" th:text="${kr.monthCount}">0</span> ·
              연속 <span th:text="${kr.streak}">0</span>일
            </div>

            <!-- ✅ 미니 그래프 (주/월) -->
            <div class="mini-graphs">
              <div class="mini-graph" data-type="week">
                <span class="mini-label">주</span>
                <div class="mini-bar"><div class="mini-fill" style="width:0%"></div></div>
                <span class="mini-percent">0%</span>
              </div>
              <div class="mini-graph" data-type="month">
                <span class="mini-label">월</span>
                <div class="mini-bar"><div class="mini-fill" style="width:0%"></div></div>
                <span class="mini-percent">0%</span>
              </div>
            </div>
          </div>

          <form th:action="@{/okr/check}" method="post" style="margin:0;">
            <input type="hidden" name="keyResultId" th:value="${kr.id}" />
            <!-- (시큐리티 사용 시) CSRF -->
            <!-- <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/> -->

            <button type="submit"
                    class="toggle-btn"
                    th:classappend="${kr.checkedToday} ? ' is-on' : ''"
                    th:attr="aria-pressed=${kr.checkedToday}">
              <span th:text="${kr.checkedToday} ? '완료' : '체크'">체크</span>
            </button>
          </form>

          <div style="display:flex; gap:8px; margin-left:12px;">
            <a th:href="@{|/okr/kr/${kr.id}|}"><button type="button">세부보기</button></a>
            <button type="button" class="edit-toggle-btn">수정</button>
            <form th:action="@{/okr/kr/{id}/delete(id=${kr.id})}" method="post"
                  onsubmit="return confirm('이 핵심 결과를 삭제할까요? 연결된 체크 기록도 함께 삭제됩니다.');">
              <!-- (시큐리티 사용 시) CSRF -->
              <!-- <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/> -->
              <button type="submit">삭제</button>
            </form>
          </div>
        </div>

        <!-- ✅ KR 인라인 수정 폼 (기본 숨김) -->
        <form th:action="@{/okr/kr/{id}/edit(id=${kr.id})}" method="post"
              class="kr-edit-form" style="display:none; margin-top:10px;">
          <!-- (시큐리티 사용 시) CSRF -->
          <!-- <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/> -->
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <input type="text" name="content" th:value="${kr.content}"
                   style="flex:1; padding:8px; border:1px solid var(--border); border-radius:8px;" required>
            <input type="number" name="progress" min="0" max="100" th:value="${kr.progress}"
                   style="width:140px; padding:8px; border:1px solid var(--border); border-radius:8px;"
                   placeholder="진행률(0~100)">
            <div style="display:flex; gap:8px;">
              <button type="submit" class="toggle-btn">저장</button>
              <button type="button" class="toggle-btn" data-role="cancel-edit">취소</button>
            </div>
          </div>
        </form>
      </li>
    </ul>
  </div>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>



<!-- ✅ 인라인 수정 토글 스크립트 -->
<script>
  // '수정' 버튼 클릭 시 해당 KR의 수정 폼 열기/닫기
  document.addEventListener('click', function (e) {
    const btn = e.target.closest('.edit-toggle-btn');
    if (!btn) return;
    const krItem = btn.closest('.kr-item');
    const form = krItem && krItem.querySelector('.kr-edit-form');
    if (!form) return;
    form.style.display = (form.style.display === 'none' || !form.style.display) ? 'block' : 'none';
  });

  // '취소' 버튼 클릭 시 폼 닫기
  document.addEventListener('click', function (e) {
    const cancel = e.target.closest('button[data-role="cancel-edit"]');
    if (!cancel) return;
    const form = cancel.closest('.kr-edit-form');
    if (form) form.style.display = 'none';
  });
</script>

<!-- ✅ 미니 그래프 퍼센트 채우기 스크립트 -->
<script>
  (function renderMiniGraphs(){
    const now = new Date();                // 클라이언트 시간 (TZ=Asia/Seoul 환경이면 동일)
    const dow = (now.getDay() + 6) % 7;    // 월=0, 화=1, ... 일=6 로 환산
    const weekDenom = dow + 1;             // ✅ 이번 주 월요일부터 ‘오늘까지’ 경과 일수 (1~7)

    const monthDenom = now.getDate();      // ✅ 이번 달 ‘오늘까지’ 경과 일수 (1~31)

    document.querySelectorAll('.kr-item').forEach(item => {
      const weekCountEl = item.querySelector('.kr-week');
      const monthCountEl = item.querySelector('.kr-month');
      if (!weekCountEl || !monthCountEl) return;

      const weekCount = parseInt(weekCountEl.textContent.trim(), 10) || 0;
      const monthCount = parseInt(monthCountEl.textContent.trim(), 10) || 0;

      // ✅ 퍼센트 계산: ‘오늘까지’ 분모 사용 → 서버(StatsServiceImpl)와 일치
      const weekPct  = Math.max(0, Math.min(100, Math.round((weekCount  / weekDenom ) * 100)));
      const monthPct = Math.max(0, Math.min(100, Math.round((monthCount / monthDenom) * 100)));

      const weekGraph = item.querySelector('.mini-graph[data-type="week"]');
      if (weekGraph) {
        const fill  = weekGraph.querySelector('.mini-fill');
        const pctEl = weekGraph.querySelector('.mini-percent');
        if (fill)  fill.style.width = weekPct + '%';
        if (pctEl) pctEl.textContent = weekPct + '%';
      }

      const monthGraph = item.querySelector('.mini-graph[data-type="month"]');
      if (monthGraph) {
        const fill  = monthGraph.querySelector('.mini-fill');
        const pctEl = monthGraph.querySelector('.mini-percent');
        if (fill)  fill.style.width = monthPct + '%';
        if (pctEl) pctEl.textContent = monthPct + '%';
      }
    });
  })();
</script>
</body>
</html>